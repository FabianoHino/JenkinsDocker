properties([pipelineTriggers([githubPush()])])

pipeline {
    agent {
        docker {
            image 'fabianohino/teste-audiencia-api:latest'
            args '-i --entrypoint='
        }
    }
    stages {
        stage('Test') {
            steps {
                sh 'pytest'
            }
        }
    
        stage("Deployment") {
            steps {
                sshPublisher(publishers: [
                        sshPublisherDesc(configName: 'testeAudienciaHomologServer',
                        sshCredentials: [
                            encryptedPassphrase: 'teste', 
                            key: '', 
                            keyPath: '.ssh/id_rsa', 
                            username: 'admin'
                        ], 
                        transfers: [
                        sshTransfer(cleanRemote: false, 
                        excludes: '', 
                        execCommand: '''#!/bin/bash
                            docker cp main.py testeAudienciaHomolog:/app/main.py
                            docker docker container restart testeAudienciaHomolog
                        ''', 
                        execTimeout: 120000, 
                        flatten: false, 
                        makeEmptyDirs: false, 
                        noDefaultExcludes: false, 
                        patternSeparator: '[, ]+', 
                        remoteDirectory: '/home/admin/testeAudiencia/', 
                        remoteDirectorySDF: false, 
                        removePrefix: '', 
                        sourceFiles: '/var/jenkins_home/workspace/testeAudiencia/*')
                    ], 
                    usePromotionTimestamp: false, 
                    useWorkspaceInPromotion: false, 
                    verbose: false) 
                ])
            }
        }
    }
}